import { useEffect, useState } from 'react'
import api from './lib/api'
import './App.css'
import Dashboard from './components/dashboard'
import MealLog from './components/mealLog'
import FitnessForm from './components/fitnessForm'
import MealsList from './components/mealsList'

function App() {
  const [token, setToken] = useState(localStorage.getItem('token') || '')
  const [registerUsername, setRegisterUsername] = useState('')
  const [registerEmail, setRegisterEmail] = useState('')
  const [registerPassword, setRegisterPassword] = useState('')
  const [loginEmail, setLoginEmail] = useState('')
  const [loginPassword, setLoginPassword] = useState('')
  const [view, setView] = useState('dashboard') // 'dashboard' | 'fitness' | 'meal' | 'meals'
  const [message, setMessage] = useState('')
  const [theme, setTheme] = useState(localStorage.getItem('theme') || 'dark')

  useEffect(() => {
    if (token) localStorage.setItem('token', token)
  }, [token])

  useEffect(() => {
    document.documentElement.setAttribute('data-theme', theme)
    localStorage.setItem('theme', theme)
  }, [theme])

  const toggleTheme = () => setTheme((t) => (t === 'dark' ? 'light' : 'dark'))

  const register = async (e) => {
    e.preventDefault()
    setMessage('')
    try {
      const res = await api.post('/users/register', {
        username: registerUsername,
        email: registerEmail,
        password: registerPassword
      })
      setToken(res.data.token)
      setMessage('Registered successfully')
      setRegisterPassword('')
    } catch (err) {
      setMessage(err?.response?.data?.msg || 'Register failed')
    }
  }

  const login = async (e) => {
    e.preventDefault()
    setMessage('')
    try {
      const res = await api.post('/users/login', { email: loginEmail, password: loginPassword })
      setToken(res.data.token)
      setMessage('Logged in')
      setLoginPassword('')
    } catch (err) {
      setMessage(err?.response?.data?.msg || 'Login failed')
    }
  }

  const logout = () => {
    localStorage.removeItem('token')
    setToken('')
  }

  return (
    <div className="container">
      <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
        <h1 className="title" style={{ flex: 1 }}>Health & Fitness Tracker</h1>
        <button className="btn ghost" onClick={toggleTheme} aria-label="Toggle theme">
          {theme === 'dark' ? 'Light mode' : 'Dark mode'}
        </button>
      </div>

      {!token ? (
        <div className="grid-2">
          <form onSubmit={register} className="card form">
            <strong>Register</strong>
            <input className="input" value={registerUsername} onChange={(e) => setRegisterUsername(e.target.value)} placeholder="Username" />
            <input className="input" value={registerEmail} onChange={(e) => setRegisterEmail(e.target.value)} placeholder="Email" />
            <input className="input" type="password" value={registerPassword} onChange={(e) => setRegisterPassword(e.target.value)} placeholder="Password" />
            <button className="btn primary" type="submit">Register</button>
          </form>
          <form onSubmit={login} className="card form">
            <strong>Login</strong>
            <input className="input" value={loginEmail} onChange={(e) => setLoginEmail(e.target.value)} placeholder="Email" />
            <input className="input" type="password" value={loginPassword} onChange={(e) => setLoginPassword(e.target.value)} placeholder="Password" />
            <button className="btn primary" type="submit">Login</button>
          </form>
          {message && <div className="message">{message}</div>}
        </div>
      ) : (
        <>
          <div className="nav">
            <button className={`nav-btn ${view==='dashboard' ? 'active' : ''}`} onClick={() => setView('dashboard')}>Dashboard</button>
            <button className={`nav-btn ${view==='fitness' ? 'active' : ''}`} onClick={() => setView('fitness')}>Log Fitness</button>
            <button className={`nav-btn ${view==='meal' ? 'active' : ''}`} onClick={() => setView('meal')}>Log Meal</button>
            <button className={`nav-btn ${view==='meals' ? 'active' : ''}`} onClick={() => setView('meals')}>Meals</button>
            <span style={{ marginLeft: 'auto', display: 'inline-flex', gap: 8 }}>
              <button className="btn ghost" onClick={toggleTheme}>{theme === 'dark' ? 'Light' : 'Dark'}</button>
              <button className="btn ghost" onClick={logout}>Logout</button>
            </span>
          </div>
          <div className="section card">
            {view === 'dashboard' && <Dashboard />}
            {view === 'fitness' && <FitnessForm />}
            {view === 'meal' && <MealLog />}
            {view === 'meals' && <MealsList />}
          </div>
        </>
      )}
    </div>
  )
}

export default App

